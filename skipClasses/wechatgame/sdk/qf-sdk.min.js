(function(){'use strict';var a=Math.floor,b=String.fromCharCode;let c={};c.Version='1.5.4',c.ClientVer='v1.0.0',c.RunModeType={Dev:'Dev',Test:'Test',Prod:'Prod'},c.RunMode=c.RunModeType.Dev,c.NetURL={Dev:{HOST:'http://192.168.100.27:31500',logHOST:'http://192.168.100.27:31500',serveHOST:'http://192.168.100.27:31500'},Test:{HOST:'http://brain-test.qfun.com',logHOST:'http://brain-test.qfun.com',serveHOST:'http://brain-test.qfun.com'},Prod:{HOST:'https://appspot.qfun.com',logHOST:'https://appspot.qfun.com',serveHOST:'https://appspot.qfun.com'}},c.MessageHead={Login:'/user_login',GetUserInfo:'/get_user_info',CreateOrder:'',QRCode:'',CancelOrder:'',MinigameCallback:'',ShareInfo:'/wxgame_share_log',MpBinding:'',Log:'/wxgame_log',DefaultSet:'',IpCheck:'',ErrorLog:'/wxgame_log',StatLog:'/wxgame_log',ExtUserInfo:'',FetchAds:'/other_game_promotion_detail'},c.Errors={NetWorkErr:{errCode:1e3,errMsg:'\u7F51\u7EDC\u9519\u8BEF'},WXCodeErr:{errCode:1001,errMsg:'\u5FAE\u4FE1Code\u83B7\u53D6\u5931\u8D25'},PayCancel:{errCode:1002,errMsg:'\u652F\u4ED8\u53D6\u6D88'},PayFail:{errCode:1003,errMsg:'\u652F\u4ED8\u5931\u8D25'},WXSessionFail:{errCode:1004,errMsg:'\u5FAE\u4FE1session\u83B7\u53D6\u5931\u8D25'},WXGetShareInfoFail:{errCode:1005,errMsg:'\u83B7\u53D6\u5206\u4EAB\u6570\u636E\u5931\u8D25'},IOSCantPay:{errCode:1006,errMsg:'IOS\u8BBE\u5907\u6682\u4E0D\u5F00\u653E\u652F\u4ED8\u529F\u80FD'},AdsDataErr:{errCode:1001,errMsg:'\u6CA1\u6709\u5E7F\u544A\u6570\u636E'},CantUseNavFun:{errCode:0,errMsg:'\u65E0\u6CD5\u4F7F\u7528\u65B9\u6CD5\u8DF3\u8F6C\u5C0F\u7A0B\u5E8F'}},c.StorageKeys={UserInfo:'__qf_miniSDK_User_Info',RunMode:'__qf_miniSDK_Run_Mode',SaveTime:'__qf_miniSDK_Save_Time',LastLogReportTime:'__qf_miniSDK_Last_Log_Report_Time',LastLogReportStr:'__qf_miniSDK_Last_Log_Report_Str',HeartBeatTimes:'__qf_miniSDK_HeartBeatTimes',OnlineBeatTimes:'__qf_miniSDK_OnlineBeatTimes',SDK_LastIndex:'__qf_SDK_LastIndex'},c.LogType={Scene:1,Share:2,Login:3,Channel:4,Signup:5,Flag:6,Err:7,MidashiPaySuccess:8,OrderPaySuccess:9,AuthFailed:10,ShareShowCount:11,ShareSuccessCount:12,MidashiPayCall:13,GameZone:14,ADClick:15,ADShow:16,ADClose:17,ClickAd:18,ShowAd:19},c.HortorLogTp={error:'error',warn:'warn',debug:'debug'};class e{static showLoading(a){!this.loading&&wx.showLoading&&(this.loading=!0,wx.showLoading({title:a,mask:!0}))}static hideLoading(){this.loading=!1,wx.showLoading&&wx.hideLoading()}static assign(c,a){if(Object.assign)return Object.assign(c,a);for(let b in a)c[b]=a[b];return c}static jsonToQuery(a){let b=[];for(let c in a)b.push(`${c}=${a[c]}`);return b.join('&')}static queryToJson(a){if(!a)return{};let b={},c=decodeURIComponent(a),d=c.split('&');for(let c in d){let a=d[c].split('=');b[a[0]]=a[1]}return b}static addToQuery(a,b={}){let c=this.queryToJson(a||''),d=this.assign(c,b);return this.jsonToQuery(d)}static resetBaseDef(a,b){for(let c in a=a||{},b=b||{},b)a[c]='undefined'==typeof a[c]?b[c]:a[c];return a}static getWXErrInfo(a){let b=a.errMsg.split(' ');return 2==b.length?b[1]:2<b.length?msg.slice(1).join(' '):'fail'}static utf8_decode(a){var d='';for(let e=0,f=0,c=0,g=0;e<a.length;)f=a.charCodeAt(e),128>f?(d+=b(f),e++):191<f&&224>f?(c=a.charCodeAt(e+1),d+=b((31&f)<<6|63&c),e+=2):(c=a.charCodeAt(e+1),g=a.charCodeAt(e+2),d+=b((15&f)<<12|(63&c)<<6|63&g),e+=3);return d}static base64Decode(a){var c,d,f,g,h,j,k,l='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=',m='',n=0;for(a=a.replace(/[^A-Za-z0-9\+\/\=]/g,'');n<a.length;)g=l.indexOf(a.charAt(n++)),h=l.indexOf(a.charAt(n++)),j=l.indexOf(a.charAt(n++)),k=l.indexOf(a.charAt(n++)),c=g<<2|h>>4,d=(15&h)<<4|j>>2,f=(3&j)<<6|k,m+=b(c),64!=j&&(m+=b(d)),64!=k&&(m+=b(f));return e.utf8_decode(m)}static getSystemInfo(){return this.systemInfo?this.systemInfo:(this.systemInfo=wx.getSystemInfoSync(),this.systemInfo.hortorSDKVersion=c.Version,this.systemInfo)}static getSystemInfoStr(){if(this.systemInfoStr)return this.systemInfoStr;let a=this.getSystemInfo(),b={};return['SDKVersion','brand','model','system','version','hortorSDKVersion'].map((c)=>{b[c]=a[c]}),this.systemInfoStr=JSON.stringify(b),this.systemInfoStr}static compareVersion(a,b){a=a.split('.'),b=b.split('.');for(var c=Math.max(a.length,b.length);a.length<c;)a.push('0');for(;b.length<c;)b.push('0');for(var d=0;d<c;d++){var e=parseInt(a[d]),f=parseInt(b[d]);if(e>f)return 1;if(e<f)return-1}return 0}static geVersion(a){return 0<=this.compareVersion(this.getSystemInfo().SDKVersion,a)}static ltVersion(a){return 0>this.compareVersion(this.getSystemInfo().SDKVersion,a)}static isFun(a){return a&&'function'==typeof a}static getNowSec(){return a(new Date().getTime()/1e3)}static setStorage(a,b){let d=c.StorageKeys[a];if(d&&'undefined'!=typeof b)try{wx.setStorageSync(d,b)}catch(a){console.warn(`[SDK] set ${d} err`,a)}}static getStorage(a){let b=c.StorageKeys[a];if(!b)return'';let d='';try{d=wx.getStorageSync(b)}catch(a){console.warn(`[SDK] get ${b} err`,a)}return d}static clearStorage(a){wx.removeStorageSync(c.StorageKeys[a])}static setStorageUser(a){this.userInfo=a,this.setStorage('UserInfo',a)}static getStorageUser(){return this.userInfo=this.userInfo||this.getStorage('UserInfo'),this.userInfo}static getUserSdk(){let a=this.getStorageUser(),b=a?a.userSdk:{};return b||{}}static clearStorageUser(){this.userInfo=null,this.clearStorage('UserInfo')}static isSystem(a){a=a.toLowerCase();let b=this.is||{};if('undefined'!=typeof b[a])return b[a];let c=this.getSystemInfo().system.toLowerCase();return b[a]=-1<c.indexOf(a),this.is=b,b[a]}static isIOS(){return this.isSystem('ios')}static isAndroid(){return this.isSystem('android')}}class d{constructor(){}init(a){this.HOST=c.NetURL[a.env].HOST,this.Log_HOST=c.NetURL[a.env].logHOST,this.Serve_HOST=c.NetURL[a.env].serveHOST,a.Server_URL&&(this.HOST=a.Server_URL)}request(a,b,d,f){let g=/^(https?:\/\/)/,h=g.test(b)?b:this.HOST+b,i=e.assign({},d.params);i.sysInfo=e.getSystemInfoStr();let j={"content-type":f?'application/json':'application/x-www-form-urlencoded'},k=(a)=>{let b={errMsg:a.errMsg||a||'',errCode:a.errCode||c.Errors.NetWorkErr.errCode};e.isFun(d.fail)?d.fail(b):console.warn('[SDK] request fail: ',b)};return wx.request({url:h,data:i,method:a,header:j,success:(a)=>{let b=a.data;return 200==a.statusCode?b.ret&&0>b.ret?k(b.error):void(e.isFun(d.success)&&d.success(b.data)):k(b)},complete:()=>{e.isFun(d.complete)&&d.complete()},fail:k})}get(a,b){return this.request('GET',a,b)}post(a,b){return this.request('POST',a,b)}getJSON(a,b){return this.request('GET',a,b,!0)}postJSON(a,b){return this.request('POST',a,b,!0)}}class f{constructor(){}addEvent(a,b){let c=this.events[a];c?this.events[a].push(b):(this.events[a]=[],this.events[a].push(b)),this.dispatchEvent('_sdkMethodAdded',a)}removeEvent(a,b){let c=this.events[a],d=c.indexOf(b);-1<d?c.splice(d,1):delete this.events[a]}dispatchEvent(a,b){let c=this.events[a];if(c)for(let a,d=0;d<c.length;d++)a=c[d],a(b)}_callHandle(a,b){if(a)for(let c,d=0;d<a.length;d++)c=a[d],c(b)}_handleOnShow(a){if(a){this.lastLaunchOptions=a;for(let b=0;b<this.sdkEvents.length;b++){let c=this.sdkEvents[b],d=this.events[c],e=a;'getMiniCode'==c&&(e=this.getSceneQuery(e)),this._callHandle(d,e)}}}_sdkMethodHandle(a){if(0<=this.sdkEvents.indexOf(a))for(let a=0;a<this.sdkEvents.length;a++){let b=this.sdkEvents[a],c=this.events[b],d=this.lastLaunchOptions;if('getMiniCode'==b){let a=this.getSceneQuery(d);a&&this._callHandle(c,a);continue}this._callHandle(c,d)}}getMiniCodeSync(){return this.getSceneQuery(this.lastLaunchOptions)}getSceneQuery(a){if(!a)return null;if(!a.query)return null;if(a.query.scene){let b=e.queryToJson(a.query.scene);return b.channel?null:(b=e.base64Decode(a.query.scene),b)}return null}init(a){this.conf=a,this.sdkEvents=['getMiniCode'],this.events={},this.lastLaunchOptions=null,this.addEvent('_handleOnShow',this._handleOnShow.bind(this)),this.addEvent('_sdkMethodAdded',this._sdkMethodHandle.bind(this))}static getInstance(a){return this.instance||(this.instance=new f,this.instance.init(a)),this.instance}}class g{getUserInfo(){let{userId:a,uniqueId:b}=e.getUserSdk();return a?{userId:a,uniqueId:b}:''}doHandleOnShow(a,b){if(this.lastLaunchOptions=a,!this.launchFlag)return;let g={};g.gameId=this.conf.gameId,g.logType=c.LogType.Scene,g.content=a,g.scene=parseInt(g.content.scene),a.minisdkVersion=c.Version,this.channel=this.conf.channel||'brain',1074==g.scene&&(this.sceneQuery=g.content.query),g.content.query.shareConfigId&&(this.shareConfigId=g.content.query.shareConfigId),g.content.query.h_shareCode&&(this.h_shareCode=g.content.query.h_shareCode),g.channel=this.channel,g.shareConfigId=this.shareConfigId,this.scene=g.scene,f.getInstance().dispatchEvent('_handleOnShow',a);let d=this.getUserInfo();d&&(g=e.assign(g,d),b&&this.postLog(g))}handleOnShow(a){this.doHandleOnShow(a,!1)}handleOnHide(a){f.getInstance().dispatchEvent('_handleOnHide',a)}getNow(){return a(new Date().getTime()/1e3)}getStorageReportStr(){return e.getStorage('LastLogReportStr')||''}getStorageReportTime(){return e.getStorage('LastLogReportTime')||this.getNow()}init(a){this.channel='brain',this.shareConfigId='',this.h_shareCode='',this.scene=0,this.pageQuery='',this.sceneQuery={},this.lastReportStr=this.getStorageReportStr(),this.lastReportTime=this.getStorageReportTime(),this.conf=a,this.network=new d,this.network.init(a),this.launchFlag=!0;let b=wx.getLaunchOptionsSync();this.handleOnShow(b,!1),this.launchFlag=!1,this.payManager=null,setTimeout(()=>{this.launchFlag=!0},1e3),wx.onShow(this.handleOnShow.bind(this)),wx.onHide(this.handleOnHide.bind(this))}repostSceneLog(){this.doHandleOnShow(this.lastLaunchOptions,!0)}postLog(a,b){if(!a.userId&&!a.uniqueId){let b=this.getUserInfo();b&&(a=e.assign(a,b))}let d=e.assign({params:a},b||{});this.network.post(`${this.network.Log_HOST}${c.MessageHead.Log}`,d)}static getInstance(a){return this.instance||(this.instance=new g,this.instance.init(a)),this.instance}}class h{constructor(a){this.conf=a,this.network=new d,this.network.init(a)}customerService(a){wx.openCustomerServiceConversation(a)}getDefaultSet(a,b){b(null)}checkIP(a,b){'function'==typeof a&&(b=a,a='');let{gameId:d='',gameVersion:f=''}=this.conf;this.network.post(`${this.network.Serve_HOST}${c.MessageHead.IpCheck}`,{params:{gameId:d,gameVersion:f,interfaceId:a},success:(a)=>{e.isFun(b)&&b(a)},fail:()=>{e.isFun(b)&&b(!1)}})}setUserCloudStorage(a){wx.setUserCloudStorage(a)}getExtUserInfo(a){let b=e.getUserSdk();if(!b||!b.userId)return a(null,{errCode:1001,errMsg:'\u83B7\u53D6\u7528\u6237\u4FE1\u606F\u5931\u8D25'});let d={userId:b.uniqueId,gameId:this.conf.gameId};this.network.get(`${this.network.Serve_HOST}${c.MessageHead.ExtUserInfo}`,{params:d,success:(b)=>{console.log('[SDK] getExtUserInfo',b),a(b)},fail:(b)=>{console.log('[SDK] getExtUserInfo err',b),a(null,b)}})}debugLog(a,b,d=c.HortorLogTp.debug){if(!a&&!b)return!1;b=b||{},'string'==typeof a?b.msg=b.msg||a:'object'==typeof a&&(b=a,a=b.msg||''),console.log(`${d}: ${a}`,b);let{userId:f,uniqueId:g}=e.getUserSdk(),h=e.assign({gameId:this.conf.gameId,gameVersion:this.conf.gameVersion||'',logTp:b.logTp,userId:f,uniqueId:g,hortorLogTp:d},b);this.network.post(`${this.network.Serve_HOST}${c.MessageHead.ErrorLog}`,{params:h,success:()=>{}})}warnLog(a,b){this.debugLog(a,b,c.HortorLogTp.warn)}errorLog(a,b){this.debugLog(a,b,c.HortorLogTp.error)}windowOnError(a){wx.onError((b)=>{this.errorLog('window on err',b),e.isFun(a)&&a(b)})}statLog(a,b){let{userId:d,uniqueId:f}=e.getUserSdk(),g=e.assign({gameId:this.conf.gameId,gameVersion:this.conf.gameVersion||'',who:f||d},a);this.network.post(`${this.network.Serve_HOST}${c.MessageHead.StatLog}`,{params:g,success:()=>{e.isFun(b)&&b(null)},fail:(a)=>{e.isFun(b)&&b(a||{})}})}static getInstance(a){return this.instance=this.instance||new h(a),this.instance}}let i={isEmpty:!0};class j{init(a){this.network=new d,this.network.init(a),this.conf=a,this.userSdk={},this.log=g.getInstance(a),this.service=h.getInstance(a),this.useBtnGetUserInfo=this.conf.sdkSet.openBtnGetUserInfo&&e.geVersion('2.0.1')&&wx.createUserInfoButton}_createSdkData(a){return a=a.userInfo||{},{channel:a.channel,h_shareCode:a.shareCode,isAuth:a.authed,uniqueId:a.userId,userId:a.userId3}}setStorageInfo(a){if(!a)return!1;let b={},c=this._createSdkData(a);b.userInfo=a,b.userSdk=c;let d=e.getStorageUser(),f=e.getNowSec();this._useEncode&&(!this.codeTemp&&console.warn('[SDK] use encode lost code'),a.code=this.codeTemp),e.setStorageUser(b),e.setStorage('RunMode',this.conf.env),e.setStorage('SaveTime',f),d||this.log.repostSceneLog()}getStorageInfo(){let a=e.getStorageUser();if(!a)return null;if(this._isAuthorizeLogin&&!a.userSdk.hasUserInfo)return null;let b=e.getStorage('SaveTime');if(!b)return null;let c=this.conf.Expire_Time?parseInt(this.conf.Expire_Time,10):86400,d=e.getNowSec();return b+c<d?(e.clearStorage('SaveTime'),null):a}checkSession(a){let b=()=>{this.checkSessionPass=!1,e.clearStorageUser(),a(null,c.Errors.WXSessionFail)};wx.checkSession({success:()=>{if(e.getStorage('RunMode')!==this.conf.env)return b();this.checkSessionPass=!0;let c=this.getStorageInfo();return c?void a(c.userInfo,null):b()},fail:b})}wxLogin(a){wx.login({success:(b)=>b.code?void a(b.code,null):a(null,c.Errors.WXCodeErr,'[SDK] \u83B7\u53D6\u7528\u6237\u767B\u5F55\u51ED\u8BC1\u5931\u8D25'),fail:(b)=>{let d=e.assign({},c.Errors.WXCodeErr);d.errMsg+=JSON.stringify(b),a(null,d,'[SDK] \u83B7\u53D6\u7528\u6237\u767B\u5F55\u72B6\u6001\u5931\u8D25')}})}entry(a,b){let d={version:c.Version,gameId:this.conf.gameId,channel:this.log.channel,query:this.log.pageQuery,shareConfigId:this.log.shareConfigId,h_shareCode:this.log.h_shareCode,isWeak:!this._isAuthorizeLogin};this._useEncode?(this.codeTemp=a,this.encodeManager=i.getInstance(this.conf),d.nonce=this.encodeManager.encodeCode(a)):d.code=a,this.network.post(c.MessageHead.Login,{params:d,success:(a)=>{this.setStorageInfo(a),b(a,null)},fail:(a)=>{e.clearStorageUser(),b(null,a)}})}postUserInfo(a={}){e.hideLoading();let b=e.getStorageUser(),d=b&&b.userSdk?b.userSdk:this.userSdk;if(!a||!d)return console.warn('[SDK] without userSdk');let{userId:f,uniqueId:g}=d;this.network.post(c.MessageHead.GetUserInfo,{params:{entryAlias:'minisdk',gameId:this.conf.gameId,openid:f,uniqueId:g,encrypted_data:a.encryptedData,iv:a.iv},success:(a)=>{this.setStorageInfo(a),this.onLogin(a,null)},fail:(a)=>{this.onLogin(null,a)}})}decodeUserInfo(a,b){a.gameId=this.conf.gameId,this.network.post(c.MessageHead.GetUserInfo,{params:a,success:(a)=>{let c=e.getStorageUser()||{};c.userInfo&&(c.userInfo=a),e.setStorageUser(a),b(a,null,this.checkSessionPass)},fail:(a)=>{b(null,a,this.checkSessionPass)}})}fetchUserInfo(){console.log('[SDK] fetchUserInfo'),wx.getUserInfo({withCredentials:!0,lang:'zh_CN',success:(a)=>{this.postUserInfo(a)},fail:()=>{this.useBtnGetUserInfo&&e.isFun(this.showGetUserInfoBtn)?this.showGetUserInfoBtn():this.onLogin(null,c.Errors.NetWorkErr,'[SDK] \u83B7\u53D6\u7528\u6237\u4FE1\u606F\u5931\u8D25')}})}_checkAuth(a,b){wx.getSetting({success:(c)=>{let d=c.authSetting['scope.userInfo'];d?a():e.isFun(b)&&b()},fail:()=>{e.isFun(b)&&b()}})}_showSetModal(a){wx.showModal({title:'\u63D0\u793A',content:'\u9700\u8981\u8BBE\u7F6E\u5F00\u542F\u5FAE\u4FE1\u8BBF\u95EE\u4FE1\u606F\u6743\u9650',showCancel:!1,confirmText:'\u53BB\u8BBE\u7F6E',success:(b)=>{b.confirm&&this._toSetting(a)},fail:()=>{this._showSetModal(a)}})}_toSetting(a){wx.openSetting({success:(b)=>{b.authSetting['scope.userInfo']?e.isFun(a)&&a():this._showSetModal(a)},fail:()=>{this._showSetModal(a)}})}_wxAuthorize(a,b){wx.authorize({scope:'scope.userInfo',success:()=>{e.isFun(a)&&a()},fail:()=>{e.isFun(b)?b():this._toSetting(a)}})}_loginLog(a=c.LogType.Login){let{userId:b,uniqueId:d}=e.getUserSdk();this.log.postLog({gameId:this.conf.gameId,channel:this.log.channel,scene:this.log.scene,userId:b,uniqueId:d,logType:a})}getAuth(a){this.userSdk=a.userInfo,e.hideLoading(),this.useBtnGetUserInfo&&e.isFun(this.showGetUserInfoBtn)?this._checkAuth(this.fetchUserInfo.bind(this),this.showGetUserInfoBtn.bind(this)):this._wxAuthorize(this.fetchUserInfo.bind(this))}onLogin(a,b,c){e.hideLoading(),a?this._loginLog():c=c||b.errMsg||'[SDK] \u672A\u83B7\u53D6\u5230\u7528\u6237\u4FE1\u606F',c&&this.service.errorLog(c,b),this.next(a,b,this.checkSessionPass)}_doLogin(a){e.showLoading('\u767B\u5F55\u4E2D...'),this.next=a,this.checkSession((a,b)=>!b&&a?this.onLogin(a):void this.wxLogin((a,b,c)=>b?this.onLogin(null,b,c):void this.entry(a,(a,b,c)=>b?this.onLogin(null,b,c):void(this._isAuthorizeLogin?this.getAuth(a):this.onLogin(a)))))}setLoginBtn(a){if(!this.useBtnGetUserInfo)return!1;let b=e.assign({lang:'zh_CN'},a)||this.conf.getUserInfoBtn||{};this.authInfoBtn&&(this.authInfoBtn.hide(),this.authInfoBtn.destroy());let c=wx.createUserInfoButton(b);return this.authInfoBtn=c,this.authInfoBtn}onLoginBtn(a){let b=this.authInfoBtn;return!!b&&void(b.offTap(),b.onTap((d)=>{console.log(d,''),d&&d.encryptedData?(this.postUserInfo(d),this.authInfoBtn.hide(),e.isFun(a)&&a(d,null,b)):(e.isFun(a)&&a(null,d,b),this._loginLog(c.LogType.AuthFailed))}))}setGetUserInfoBtn(a={}){this.setLoginBtn(a.config),this.onLoginBtn(a.onTap),this.authInfoBtn.show(),e.isFun(a.onShow)&&a.onShow()}loginFun(a,b,c,d){this._isAuthorizeLogin=!!c,this._useEncode=d&&!i.isEmpty,d&&i.isEmpty&&console.warn('[SDK] \u6B64SDK\u4E0D\u652F\u6301\u52A0\u5BC6\u767B\u5F55'),this._isAuthorizeLogin&&(this.showGetUserInfoBtn=this.setGetUserInfoBtn.bind(this,b)),this._doLogin(a)}decodeLoginFun(a,...b){this.loginFun((b,c,d)=>{b&&'string'==typeof b.userInfo?this.decodeUserInfo(b,a):a(b,c,d)},...b)}decodeLogin(a,b){this.decodeLoginFun(a,b,!0)}decodeWeakLogin(a){this.decodeLoginFun(a,null,!1)}}class k{constructor(a){this.conf=a,this.network=new d,this.network.init(a),this.log=g.getInstance(a),this.defData={},this.change='',this.ads='',this.nowAd='',this.lastIndex='',this.showing=!1,this.useBoxWeight=100;let b='undefined'!=typeof GameGlobal&&'undefined'==typeof App,c=!wx.canIUse||!wx.canIUse('navigateToMiniProgram');this.canDirectJump=!1,this.canDirectJump=wx.canIUse?wx.canIUse('navigateToMiniProgram'):'undefined'!=typeof wx.navigateToMiniProgram;let{isMiniGame:e=b,useNav:f=c}=a;console.log(`[SDK] isMiniGame: ${e}; useNav: ${f}; supportNav:${c}`),this.isMiniGame=e,this.useNav=f}_postLog(a=c.LogType.ShowAd,b){this.log.postLog({prId:b.prId||'',gameId:this.conf.gameId,channel:this.log.channel,scene:this.log.scene,logType:a})}_goApp(a,b={}){if(!this.isMiniGame&&this.useNav){let a=c.Errors.CantUseNavFun;return b.complete(a),b.success(a),!1}let{path:d,appId:f,envVersion:g,extraData:h}=a,i=e.assign(b,{path:d,appId:f,envVersion:g,extraData:h});console.log('[SDK] goApp',i),wx.navigateToMiniProgram(i)}_previewImage(a,b={}){console.log('[SDK] preview ad ',a);let c=e.assign(b,{urls:[a.url]});wx.previewImage(c)}_goGame(...a){this.isMiniGame&&!this.canDirectJump?this._previewImage(...a):this._goApp(...a)}_setAds(a){this.ads={ads:a};let b=0;for(let c in a){b=a[c].weight||0;break}this.ads.weight=b}_getAds(){return this.ads||{}}_getData(a=this.nowAd){return a}_setLastIndex(a){this.lastIndex=a,e.setStorage('SDK_LastIndex',a)}_getStorageIndex(){let a=parseInt(e.getStorage('SDK_LastIndex'),10);return isNaN(a)?'':(this.lastIndex=a,a)}_getLastIndex(){return''===this.lastIndex?this._getStorageIndex():this.lastIndex}_getRadomIndex(b){let{ads:c,weight:d}=b,e=a(Math.random()*d),g=0;return c.findIndex((a)=>{let b=a.use_box_weight,c=!!(g<=e&&e<g+b);return c||(g+=b),c})}_getRadomAdIndex(a){let b=this._getLastIndex(),c=this._getRadomIndex(a);return c==b?this._getRadomAdIndex(a):c}_getRadomAd(a){let{ads:b}=a,c=b.length,d=this._getLastIndex(),e='';return e=1===c?0:2===c?1===d?0:1:this._getRadomAdIndex(a),''===e?'':(this._setLastIndex(e),b[e])}_getSortNextAd(a){let{ads:b}=a,c=b.length;var d=this.lastIndex;return this.lastIndex=''===this.lastIndex?0:d+1<c?d+1:0,b[this.lastIndex]}reset(a){let b=this._getAds();if(b.ads&&1==b.ads.length&&this.nowAd)return console.log('[SDK] only one AD is not updated'),this._postLog(c.LogType.ShowAd,this.nowAd),e.isFun(a)&&a(f),void(e.isFun(this.change)&&this.change(this._getData(this.nowAd)));let d;if(d=b.ads&&b.ads.length?1===this.conf.showAdStrategy?this._getSortNextAd(b):this._getRadomAd(b):'',!d)return!1;this.nowAd=d,this._postLog(c.LogType.ShowAd,d);let f=this._getData(d);console.log('[SDK] now ad',f),e.isFun(a)&&a(f),e.isFun(this.change)&&this.change(f)}onChange(a){e.isFun(a)&&(this.change=a)}show(a={}){if(this.showing)return!1;if(this.showing=!0,!this.nowAd)return console.log('[SDK] no ad');let b=this.nowAd;this._postLog(c.LogType.ClickAd,b);let{success:d,fail:f,complete:g}=a;this._goGame(b,{success:(a)=>{console.log('[SDK] show success',a),e.isFun(d)&&d(a)},fail:(a)=>{console.log('[SDK] show fail',a),e.isFun(f)&&f(a)},complete:(a)=>{this.showing=!1,e.isFun(this.change)&&this.reset(),e.isFun(g)&&g(a)}})}create(a){let{gameId:b}=this.conf;console.log('[SDK] create',b);let d=(b)=>{e.isFun(a.fail)&&a.fail(b),console.log('[SDK] create fail',b)};this.network.get(`${this.network.HOST}${c.MessageHead.FetchAds}`,{params:{gameId:b},success:(b)=>b&&b.length?void(console.log('[SDK] create success',b),this._setAds(b),this.reset(a.success)):d(c.Errors.AdsDataErr),fail:d})}static getInstance(a){return this.instance=this.instance||new k(a),this.instance}}class l{constructor(a){this.conf=a,this.bridge=null}createAd(a){if(this.bridge)return this.bridge.create(a),this.bridge;let b=new k(this.conf);return b.create(a),this.bridge=b,this.bridge}showAd(a){return this.bridge?void(a=a||{},this.bridge.show(a)):console.warn('[SDK] CrossAdManager ad no init')}resetAd(a){return this.bridge?void(a=a||{},this.bridge.reset(a)):console.warn('[SDK] CrossAdManager ad no init')}static getInstance(a){return this.instance=this.instance||new l(a),this.instance}}let m={decodeLogin(...a){this.loginManager.decodeLogin(...a)},decodeWeakLogin(...a){this.loginManager.decodeWeakLogin(...a)},createCrossAd(...a){return this.crossAdManager.createAd(...a)},showCrossAd(...a){this.crossAdManager.showAd(...a)},refreshCrossAd(...a){this.crossAdManager.resetAd(...a)},init(a){if(!a||!(a instanceof Object))return console.warn('[SDK] no conf');a.sdkType='qf-minigame',a.sdkSet={openBtnGetUserInfo:!0},this.core=f.getInstance(a);let b=new j;b.init(a),this.loginManager=b,this.util=e,this.crossAdManager=l.getInstance(a)},getMiniCode(a){this.core.addEvent('getMiniCode',a)},getMiniCodeSync(){return this.core.getMiniCodeSync()}};'undefined'==typeof module?'undefined'!=typeof window&&(window.sdk=m):module.exports=m})();